version: 2

# =====================================================================
# ソース定義：Snowflake 内の生データテーブル
# =====================================================================
sources:
  - name: analytics
    description: "分析用の基本データソース"
    database: analytics
    schema: public
    tables:
      - name: raw_events
        description: "生のイベントログデータ（Webアクセスログ）"
        columns:
          - name: event_id
            description: "イベントの一意な識別子"
            tests:
              - unique
              - not_null
          - name: user_id
            description: "ユーザーID"
            tests:
              - not_null
          - name: session_id
            description: "セッションID"
            tests:
              - not_null
          - name: event_type
            description: "イベント種別"
            tests:
              - accepted_values:
                  values: ['page_view', 'click', 'purchase', 'sign_up', 'add_to_cart', 'checkout']
              - not_null
          - name: page_url
            description: "ページURL"
          - name: event_timestamp
            description: "イベント発生日時（UTC）"
            tests:
              - not_null
          - name: device_type
            description: "デバイス種別"
            tests:
              - accepted_values:
                  values: ['desktop', 'mobile', 'tablet']
          - name: country
            description: "国コード（ISO 3166-1 alpha-2）"

      - name: users
        description: "ユーザーマスタ情報"
        columns:
          - name: user_id
            description: "ユーザーID（主キー）"
            tests:
              - unique
              - not_null
          - name: signup_date
            description: "登録日"
            tests:
              - not_null
          - name: country
            description: "国コード"
          - name: plan_type
            description: "プランタイプ"
            tests:
              - accepted_values:
                  values: ['free', 'premium']
              - not_null
          - name: is_active
            description: "アクティブフラグ"
            tests:
              - not_null

      - name: sessions
        description: "セッション単位の集約データ"
        columns:
          - name: session_id
            description: "セッションID（主キー）"
            tests:
              - unique
              - not_null
          - name: user_id
            description: "ユーザーID"
            tests:
              - not_null
              - relationships:
                  to: source('analytics', 'users')
                  field: user_id
          - name: session_start
            description: "セッション開始時刻"
            tests:
              - not_null
          - name: session_end
            description: "セッション終了時刻"
          - name: page_views
            description: "ページビュー数"
          - name: device_type
            description: "デバイス種別"


# =====================================================================
# モデル定義とテスト：Staging Layer
# =====================================================================
models:
  - name: stg_events
    description: "前処理済みイベントログ（VIEW）"
    columns:
      - name: event_id
        description: "イベントID（主キー）"
        tests:
          - unique
          - not_null
      - name: user_id
        description: "ユーザーID"
        tests:
          - not_null
      - name: event_type
        description: "標準化されたイベント種別"
        tests:
          - accepted_values:
              values: ['PAGE_VIEW', 'CLICK', 'PURCHASE', 'SIGN_UP', 'ADD_TO_CART', 'CHECKOUT']
      - name: funnel_stage
        description: "ファネル分析用のステージ（Acquisition, Consideration, Conversion）"
        tests:
          - accepted_values:
              values: ['Engagement', 'Consideration', 'Conversion', 'Acquisition', 'Other']

  - name: stg_users
    description: "前処理済みユーザーマスタ（VIEW）"
    columns:
      - name: user_id
        description: "ユーザーID（主キー）"
        tests:
          - unique
          - not_null
      - name: plan_type
        description: "プランタイプ"
        tests:
          - accepted_values:
              values: ['free', 'premium']
      - name: user_segment
        description: "ユーザーセグメント（Premium Active等）"
        tests:
          - not_null
      - name: cohort
        description: "ユーザーコホート（New, Onboarding等）"
        tests:
          - accepted_values:
              values: ['New', 'Onboarding', 'Established', 'Long-term']


# =====================================================================
# モデル定義とテスト：Intermediate Layer
# =====================================================================
  - name: int_daily_events
    description: "日別・国別イベント集計（中間モデル、VIEW）"
    columns:
      - name: event_date
        description: "イベント日"
        tests:
          - not_null
      - name: country
        description: "国コード"
      - name: plan_type
        description: "プランタイプ"
      - name: unique_users
        description: "ユニークユーザー数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: total_events
        description: "イベント総数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: purchase_events
        description: "購入イベント数"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0


# =====================================================================
# モデル定義とテスト：Mart Layer
# =====================================================================
  - name: daily_summary
    description: "日別パフォーマンスサマリー（最終レポート用テーブル）"
    columns:
      - name: event_date
        description: "イベント日"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - event_date
            - country
            - plan_type
            - user_segment
      - name: country
        description: "国コード"
        tests:
          - not_null
      - name: plan_type
        description: "プランタイプ"
        tests:
          - accepted_values:
              values: ['free', 'premium']
      - name: unique_users
        description: "ユニークユーザー数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: purchase_rate
        description: "購入レート（購入イベント数 / ユーザー数）"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
      - name: user_conversion_rate
        description: "ユーザーコンバージョンレート"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1

  - name: weekly_summary
    description: "週別パフォーマンスサマリー"
    columns:
      - name: week_start_date
        description: "週の開始日"
        tests:
          - not_null
      - name: country
        description: "国コード"
      - name: plan_type
        description: "プランタイプ"
      - name: total_weekly_users
        description: "週間ユニークユーザー数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: total_weekly_purchases
        description: "週間購入イベント数"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: purchase_rate
        description: "週間購入レート"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1


# =====================================================================
# 汎用テスト定義（複数モデルで利用）
# =====================================================================
# カスタム generic テストを追加する場合は、tests/generic/ ディレクトリに
# SQLファイルとして配置してください。
# 例：tests/generic/recency.sql
#
# {% test recency(model, column_name, days) %}
#   SELECT *
#   FROM {{ model }}
#   WHERE {{ column_name }} < DATEADD(day, -{{ days }}, CURRENT_DATE())
# {% endtest %}
