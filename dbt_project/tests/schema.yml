version: 2

# =====================================================================
# ソース定義：Snowflake 内の生データテーブル
# =====================================================================
sources:
  - name: analytics
    description: "分析用の基本データソース"
    database: ANALYTICS
    schema: PUBLIC
    tables:
      - name: RAW_EVENTS
        description: "生のイベントログデータ（Webアクセスログ）"
        columns:
          - name: EVENT_ID
            description: "イベントの一意な識別子"
            tests:
              - unique
              - not_null
          - name: USER_ID
            description: "ユーザーID"
            tests:
              - not_null
          - name: SESSION_ID
            description: "セッションID"
            tests:
              - not_null
          - name: EVENT_TYPE
            description: "イベント種別"
            tests:
              - accepted_values:
                  values: ['page_view', 'click', 'purchase', 'sign_up', 'add_to_cart', 'checkout']
              - not_null
          - name: PAGE_URL
            description: "ページURL"
          - name: EVENT_TIMESTAMP
            description: "イベント発生日時（UTC）"
            tests:
              - not_null
          - name: DEVICE_TYPE
            description: "デバイス種別"
            tests:
              - accepted_values:
                  values: ['desktop', 'mobile', 'tablet']
          - name: COUNTRY
            description: "国コード（ISO 3166-1 alpha-2）"

      - name: USERS
        description: "ユーザーマスタ情報"
        columns:
          - name: USER_ID
            description: "ユーザーID（主キー）"
            tests:
              - unique
              - not_null
          - name: SIGNUP_DATE
            description: "登録日"
            tests:
              - not_null
          - name: COUNTRY
            description: "国コード"
          - name: PLAN_TYPE
            description: "プランタイプ"
            tests:
              - accepted_values:
                  values: ['free', 'premium']
              - not_null
          - name: IS_ACTIVE
            description: "アクティブフラグ"
            tests:
              - not_null

      - name: SESSIONS
        description: "セッション単位の集約データ"
        columns:
          - name: SESSION_ID
            description: "セッションID（主キー）"
            tests:
              - unique
              - not_null
          - name: USER_ID
            description: "ユーザーID"
            tests:
              - not_null
              - relationships:
                  to: source('analytics', 'USERS')
                  field: USER_ID
          - name: SESSION_START
            description: "セッション開始時刻"
            tests:
              - not_null
          - name: SESSION_END
            description: "セッション終了時刻"
          - name: PAGE_VIEWS
            description: "ページビュー数"
          - name: DEVICE_TYPE
            description: "デバイス種別"


# =====================================================================
# モデル定義とテスト：Staging Layer
# =====================================================================
models:
  - name: stg_events
    description: "前処理済みイベントログ（VIEW）"
    columns:
      - name: EVENT_ID
        description: "イベントID（主キー）"
        tests:
          - unique
          - not_null
      - name: USER_ID
        description: "ユーザーID"
        tests:
          - not_null
      - name: EVENT_TYPE
        description: "標準化されたイベント種別"
        tests:
          - accepted_values:
              values: ['PAGE_VIEW', 'CLICK', 'PURCHASE', 'SIGN_UP', 'ADD_TO_CART', 'CHECKOUT']
      - name: FUNNEL_STAGE
        description: "ファネル分析用のステージ（Acquisition, Consideration, Conversion）"
        tests:
          - accepted_values:
              values: ['Engagement', 'Consideration', 'Conversion', 'Acquisition', 'Other']

  - name: stg_users
    description: "前処理済みユーザーマスタ（VIEW）"
    columns:
      - name: USER_ID
        description: "ユーザーID（主キー）"
        tests:
          - unique
          - not_null
      - name: PLAN_TYPE
        description: "プランタイプ"
        tests:
          - accepted_values:
              values: ['free', 'premium']
      - name: USER_SEGMENT
        description: "ユーザーセグメント（Premium Active等）"
        tests:
          - not_null
      - name: COHORT
        description: "ユーザーコホート（New, Onboarding等）"
        tests:
          - accepted_values:
              values: ['New', 'Onboarding', 'Established', 'Long-term']


# =====================================================================
# モデル定義とテスト：Intermediate Layer
# =====================================================================
  - name: int_daily_events
    description: "日別・国別イベント集計（中間モデル、VIEW）"
    columns:
      - name: EVENT_DATE
        description: "イベント日"
        tests:
          - not_null
      - name: COUNTRY
        description: "国コード"
      - name: PLAN_TYPE
        description: "プランタイプ"
      - name: UNIQUE_USERS
        description: "ユニークユーザー数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: TOTAL_EVENTS
        description: "イベント総数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: PURCHASE_EVENTS
        description: "購入イベント数"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0


# =====================================================================
# モデル定義とテスト：Mart Layer
# =====================================================================
  - name: daily_summary
    description: "日別パフォーマンスサマリー（最終レポート用テーブル）"
    columns:
      - name: EVENT_DATE
        description: "イベント日"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - EVENT_DATE
            - COUNTRY
            - PLAN_TYPE
            - USER_SEGMENT
      - name: COUNTRY
        description: "国コード"
        tests:
          - not_null
      - name: PLAN_TYPE
        description: "プランタイプ"
        tests:
          - accepted_values:
              values: ['free', 'premium']
      - name: UNIQUE_USERS
        description: "ユニークユーザー数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: PURCHASE_RATE
        description: "購入レート（購入イベント数 / ユーザー数）"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
      - name: USER_CONVERSION_RATE
        description: "ユーザーコンバージョンレート"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1

  - name: weekly_summary
    description: "週別パフォーマンスサマリー"
    columns:
      - name: WEEK_START_DATE
        description: "週の開始日"
        tests:
          - not_null
      - name: COUNTRY
        description: "国コード"
      - name: PLAN_TYPE
        description: "プランタイプ"
      - name: TOTAL_WEEKLY_USERS
        description: "週間ユニークユーザー数"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: TOTAL_WEEKLY_PURCHASES
        description: "週間購入イベント数"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: PURCHASE_RATE
        description: "週間購入レート"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1


# =====================================================================
# 汎用テスト定義（複数モデルで利用）
# =====================================================================
# カスタム generic テストを追加する場合は、tests/generic/ ディレクトリに
# SQLファイルとして配置してください。
# 例：tests/generic/recency.sql
#
# {% test recency(model, column_name, days) %}
#   SELECT *
#   FROM {{ model }}
#   WHERE {{ column_name }} < DATEADD(day, -{{ days }}, CURRENT_DATE())
# {% endtest %}
